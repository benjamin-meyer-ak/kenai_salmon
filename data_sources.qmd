# UCI Salmon Fishery Data Sources {.unnumbered}

---
execute:
  echo: false
date: "`r Sys.Date()`"
format:
  html:
    code-fold: true
    code-tools: true
    code-summary: "Show the code"
---

```{r, echo = F, message = F}

#| warning: false
#| message: false


# clear environment
rm(list=ls())

# load packages
library(tidyverse)
library(janitor)
library(scales)
library(magrittr)
```

# Data Sources

```{r echo = F}


# harvest trends datasets 1966-2015
# https://catalog.epscor.alaska.edu/dataset/commercial-recreational-and-personal-use-harvest-trends-in-the-kenai-river-salmon-fishery-1966-2015

# overall run trends datasets 1976-2015
# https://catalog.epscor.alaska.edu/dataset/total-run-sizes-of-chinook-and-sockeye-salmon-in-the-kenai-river-1976-2015

```

Note on data sources for Northern Kenai Peninsula Fisheries Harvest, from Schoen et al. 2017 supplemental materials:

"Harvest and effort data are reported differently for the commercial, recreational, and personal-use fisheries in Upper Cook Inlet, such that it is not possible to calculate the harvest and effort of salmon produced specifically by the Kenai River (including its tributaries) by each fishing sector. To make comparisons within a common geographic area, we aggregated harvest and effort data from the northern Kenai Peninsula, ranging from the Kasilof River in the south to Ingram Creek in the north. The Kenai River is the predominant salmon-producing river in this area.

We aggregated harvest and effort data from the following fisheries:

-   Commercial: Central District drift gill net and east-side set gill net (Shields and Dupuis 2016);

-   Recreational: Northern Kenai Peninsula Management Area (Begich et al. 2013);

-   Personal-use: Kenai River dip net, Kasilof River dip net, and Kasilof River set net (Fall et al. 2015; Shields and Dupuis 2016). ADF&G also reports harvest and effort for an “unknown” personal-use fishery in Upper Cook Inlet. This harvest and effort was reported on permits on which the fishery was left blank. We allocated this harvest and effort to each known fishery based on the proportions of accurately reported harvest and effort in each year."

<br>

## Commercial Harvest

```{r echo = F}
# read in comm fish data
dir <- "other/input/harvest_trends/uci-commercial-salmon-harvest.csv"
uci_comm <- read.csv(dir) %>%
  clean_names() %>%
  # remove percentage columns
  select(-contains(("_2"))) %>%
  pivot_longer(cols = c("drift",
                        "essn",
                        "wssn",
                        "nsn"), names_to = "fishery", values_to = "count") %>%
  # consolidate counts from various fisheries
  group_by(species,year) %>%
  summarise(total_count = sum(count)) %>%
  mutate(harvest_group = "Commercial")

```

```{r echo = F}
# comm plot
comm_fig <- uci_comm %>%
  ggplot() +
  geom_bar(aes(x = year, y = total_count, fill = species), stat = "identity") +
  scale_y_continuous(labels = label_comma()) +
  xlab("") +
  ylab("Commercial Harvest") +
  theme_classic()
comm_fig


# the commercial harvest data set is the longest, so we will make that the axis extent for the other figures too
comm_year_min <- as.numeric(min(uci_comm$year))
comm_year_max <- as.numeric(max(uci_comm$year))

# for some visualization purposes, we want the y-axis to show the scale of the largest harvest category, commercial. Species are aggregated
# comm_harvest_min <- group_by(year) %>% summarise(total_comm_harvest = sum(total_ct)) # throws error
#comm_harvest_max

```

<br>

## Personal Use Harvest

```{r echo = F}
# read in pre 1996 PU
dir <- "other/input/harvest_trends/puharvest_pre1996.csv"
puharvest_pre1996 <- read.csv(dir) %>%
  clean_names() %>%
  # prep format
  pivot_longer(cols = c("harvest_sockeye",
                        "harvest_chinook",
                        "harvest_coho",
                        "harvest_chum",
                        "harvest_pink"), names_to = "species", values_to = "count") %>%
  select(-harvest_total) %>%
  # corrected species names
  mutate(species = case_when(
    species == "harvest_sockeye" ~ "Sockeye",
    species == "harvest_chinook" ~ "Chinook",
    species == "harvest_chum" ~ "Chum",
    species == "harvest_pink" ~ "Pink",
    species == "harvest_coho" ~ "Coho")) %>%
  # consolidate data among fisheries, as the figure does not segregate them
  group_by(species, year) %>%
  summarise(total_count = sum(count)) %>%
  transform(year = as.character(year))

```

```{r echo = F}
# read in post 1996 PU
dir <- "other/input/harvest_trends/puharvest_post1996.csv"
puharvest_post1996 <- read.csv(dir) %>%
  clean_names() %>%
  select(-source,-page) %>%
  # remove commas
  mutate_all(~sub(",","",.)) %>%
  # prep format
  pivot_longer(cols = c("fish_cr",
                        "kasilof_set",
                        "kasilof_dip",
                        "kenai",
                        "unknown"), names_to = "fishery", values_to = "count") %>%
  transform(count = as.numeric(count)) %>%
  select(-fishery) %>%
  # replace all 0 with NA
  mutate(count = na_if(count,0)) %>%
  group_by(species, year) %>%
  # recall to include na.rm = T
  summarise(total_count = sum(count, na.rm = T)) 


```

```{r echo = F}
# combine pre-1996 and post-1996 PU data
uci_pu <- bind_rows(puharvest_pre1996,puharvest_post1996) %>%
  mutate(harvest_group = "Personal Use") 


# PU plot
pu_fig <- uci_pu %>%
  filter(species != "HouseholdDaysFished") %>%
  ggplot() +
  geom_bar(aes(x = as.numeric(year), y = total_count, fill = species), stat = "identity") +
  scale_y_continuous(labels = label_comma()) +
  xlab("") +
  ylab("Personal Use Harvest") +
  xlim(comm_year_min,comm_year_max) +
  theme_classic()
pu_fig

# add secondary axis


# suggested alternative: secondary chart below w/ household days





# number format on y axis
# capitalize legend
# reverse stack order
# match colors
# secondary y-axis

```

<br>

## Sport Harvest

```{r echo = F}
# read in uci sport fish data
dir <- "other/input/harvest_trends/sportharvest.csv"
uci_sport <- read.csv(dir) %>%
  clean_names() %>%
  select(contains(c("year","area","salmon","trout","dolly","grayling","pike","other"))) %>%
  # consolidate all non-salmon species into "other"
  rowwise() %>%
  mutate(other = sum(rainbow_trout, 
                     lake_trout, 
                     dolly_varden,
                     arctic_grayling,
                     northern_pike,
                     other,
                     na.rm = T)) %>%
  # remove non-salmon species columns
  select(-rainbow_trout, -lake_trout, -dolly_varden,-arctic_grayling,-northern_pike) %>%
  pivot_longer(cols = contains(c("salmon","other")),
               names_to = "species",
               values_to = "count") %>%
  # consolidate counts from various fisheries into overall sport fishery
  group_by(year,species) %>%
  summarise(total_count = sum(count)) %>%
  # fix species names
  mutate(species = case_when(
    species == "chinook_salmon" ~ "Chinook",
    species == "chum_salmon" ~ "Chum",
    species == "coho_salmon" ~ "Coho",
    species == "pink_salmon" ~ "Pink",
    species == "sockeye_salmon" ~ "Sockeye",
    species == "other" ~ "Other")) %>%
  # name user group
  mutate(harvest_group = "Sport")

```

```{r echo = F}
# sport plot
sport_fig <- uci_sport %>%
  ggplot() +
  geom_bar(aes(x = as.numeric(year), y = total_count, fill = species), stat = "identity") +
  scale_y_continuous(labels = label_comma()) +
  xlab("") +
  ylab("Sport Harvest") +
  xlim(comm_year_min,comm_year_max) +
  theme_classic()
sport_fig

```

Next:

-   find updated data sources for sport fish harvest
-   figure out dual axes to show effort

Idea for NEW overall fig - stacked bar plot of harvest by fishery (& sub stack by species?) superimposed with total harvest ... can visualize remaining escapement in context of harvest. --\> might be hard to do becuase the above figures do not include solely kenai fish

-   secondary axes for effort: maybe? https://johnmackintosh.net/blog/2022-03-13-dual-axis/

-   step 1: recreate fig as is

-   step 2: show proportional sizes of figs in context of comm

-   step 3: show stacked proportion by fishery by year
